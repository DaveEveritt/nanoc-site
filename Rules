#!/usr/bin/env ruby

### Routing ##################################################################

route '/404/' do
  '/error-404.php'
end

route '/assets/style/' do
  # path with version
  '/assets/style' + '-v' + rep.item[:version].to_s + '.css'
end

route '/blog/feed_private/' do
  rep.item.identifier + 'index.xml'
end

[ '/manual/', '/migrating/' ].each do |pattern|
  route pattern, :rep => 'notoc' do
    nil
  end
end

route '*' do
  if item[:is_partial] || item[:kind] == 'article'
    # Donâ€™t output partial items (e.g. sub-stylesheets)
    nil
  else
    # Place each file in its own directory
    rep.item.identifier + 'index.html'
  end
end

### Compilation ##############################################################

compile '/assets/style/' do
  filter :erb
  filter :relativize_paths, :type => :css
  filter :rainpress
end

compile '/assets/style/*' do
  filter :sass
end

compile '/blog/feed_private/' do
  filter :erb
end

[ '/manual/', '/migrating/' ].each do |pattern|
  compile pattern, :rep => 'notoc' do
    filter :erb
    filter :kramdown, :auto_ids => false
    filter :add_sections
  end
end

compile '/404/' do
  filter :erb
  layout '/default/'
end

compile '/' do
  filter :erb
  layout '/default/'
  filter :relativize_paths, :type => :html
  filter :rubypants
end

compile '*' do
  filter :erb if item[:is_dynamic]

  case item[:markdown]
  when 'advanced'
    filter :kramdown, :auto_ids => false
  when 'basic'
    filter :rdiscount
  end

  filter :syntax_colorize

  snapshot :before_sections
  filter :add_sections
  layout '/default/'
  filter :add_links_to_headers
  filter :relativize_paths, :type => :html unless item[:is_partial] || item[:kind] == 'article'
  filter :rubypants
end

### Layouting ################################################################

layout '*', :erb
